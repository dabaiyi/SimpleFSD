# SimpleFSD 客户端开发接口文档

## 1. FSD 协议概述

FSD (Flight Simulation Data) 协议是用于飞行模拟网络中客户端和服务器之间通信的协议。SimpleFSD 实现了这个协议的核心功能，允许飞行员客户端和管制员客户端连接到服务器并进行实时通信和位置更新。

## 2. 通信基础

### 2.1 数据传输方式

FSD 协议使用 TCP 连接进行数据传输，每个命令以特定的前缀开头，参数之间用冒号 (`:`) 分隔，命令以换行符结尾。

### 2.2 基本格式

```
[命令前缀][参数1]:[参数2]:[参数3]:...\n
```

## 3. 核心命令详解

### 3.1 连接与认证命令

#### 3.1.1 管制员登录 (`#AA`)

**请求格式：**
```
#AA:[呼号]:[服务器名称]:[CID]:[密码]:[请求等级]:[协议版本]:[数据1]:[数据2]:[纬度]:[经度]:[数据3]
```

**示例：**
```
#AA:2352_OBS:SERVER:2352:2352:123456:1:9:1:0:29.86379:119.49287:100
```

**参数说明：**
- `[呼号]`: 管制员呼号，必须符合3-12个字符的长度限制
- `[服务器名称]`: 服务器名称，通常为"SERVER"
- `[CID]`: 用户ID
- `[密码]`: 用户密码
- `[请求等级]`: 请求的管制权限等级
- `[协议版本]`: 协议版本，目前SimpleFSD只支持9
- `[纬度]/[经度]`: 管制员所在位置的地理坐标

**返回信息：**
- 成功：服务器会广播登录消息给范围内的客户端，并向该客户端发送以下信息：
  - ATIS查询请求：`$CQ:SERVER:[呼号]:ATIS`
  - MOTD(每日消息)：服务器配置的欢迎信息
- 失败：服务器返回错误消息，如：
  - `$ER:[呼号]:Syntax error` - 语法错误
  - `$ER:[呼号]:Invalid CID/password` - CID或密码错误
  - `$ER:[呼号]:Callsign in use` - 呼号已被使用

#### 3.1.2 飞行员登录 (`#AP`)

**请求格式：**
```
#AP:[呼号]:[服务器名称]:[CID]:[密码]:[请求等级]:[协议版本]:[模拟器类型]:[真实姓名]:[出发机场]
```

**示例：**
```
#AP:CES2352:SERVER:2352:123456:1:9:16:Half_nothing:ZGHA
```

**参数说明：**
- `[呼号]`: 飞行员呼号，必须符合3-12个字符的长度限制
- `[服务器名称]`: 服务器名称，通常为"SERVER"
- `[CID]`: 用户ID
- `[密码]`: 用户密码
- `[请求等级]`: 请求的飞行员等级
- `[协议版本]`: 协议版本，目前SimpleFSD只支持9
- `[模拟器类型]`: 所使用的飞行模拟器类型代码
- `[真实姓名]`: 用户真实姓名
- `[出发机场]`: 出发机场的ICAO代码

**返回信息：**
- 成功：服务器会广播登录消息给范围内的客户端，并向该客户端发送MOTD消息
- 失败：服务器返回错误消息，与管制员登录类似

#### 3.1.3 管制员退出 (`#DA`)

**请求格式：**
```
#DA:[呼号]:[服务器名称]
```

**示例：**
```
#DA:ZGGG_CTR:SERVER
```

**参数说明：**
- `[呼号]`: 管制员呼号
- `[服务器名称]`: 服务器名称，通常为"SERVER"

**返回信息：**
- 服务器记录下线日志，并广播下线消息给范围内的客户端

#### 3.1.4 飞行员退出 (`#DP`)

**请求格式：**
```
#DP:[呼号]:[服务器名称]
```

**示例：**
```
#DP:CES2352:SERVER
```

**参数说明：**
- `[呼号]`: 飞行员呼号
- `[服务器名称]`: 服务器名称，通常为"SERVER"

**返回信息：**
- 服务器记录下线日志，并广播下线消息给范围内的客户端

### 3.2 位置更新命令

#### 3.2.1 飞行员位置更新 (`@`)

这就是您询问的 `@` 符号的作用，它是飞行员位置更新命令。

**请求格式：**
```
@:[状态标志]:[应答机编码]:[数据]:[纬度]:[经度]:[高度]:[地速]:[PBH数据]:[航向]
```

**示例：**
```
@:S:CPA421:7000:1:38.96244:121.53479:87:0:4290770974:278
```

**参数说明：**
- `[状态标志]`: 飞行员状态标志
- `[应答机编码]`: 应答机编码
- `[纬度]/[经度]`: 飞机当前位置的地理坐标
- `[高度]`: 飞机当前高度（英尺）
- `[地速]`: 飞机当前地速（节）
- `[PBH数据]`: 俯仰(Pitch)、横滚(Bank)、航向(Heading)数据的整数表示
- `[航向]`: 当前航向

**返回信息：**
- 服务器将位置更新广播给范围内的所有客户端
- 无直接返回给发送方的确认消息

#### 3.2.2 管制员位置更新 (`%`)

这就是您询问的 `%` 符号的作用，它是管制员位置更新命令。

**请求格式：**
```
%:[呼号]:[频率]:[设施类型]:[视距范围]:[管制等级]:[纬度]:[经度]:[数据]
```

**示例：**
```
%:ZSHA_CTR:24550:6:600:5:27.28025:118.28701:0
```

**参数说明：**
- `[呼号]`: 管制员呼号
- `[频率]`: 管制频率（如121.500表示为121500）
- `[设施类型]`: 管制设施类型（如塔台、进近等）
- `[视距范围]`: 管制员的可视范围
- `[管制等级]`: 管制员的权限等级
- `[纬度]/[经度]`: 管制员所在位置的地理坐标

**返回信息：**
- 成功：服务器将位置更新广播给范围内的所有客户端
- 失败：服务器可能返回错误消息，如`$ER:[呼号]:Request level too high` - 请求的管制等级过高

#### 3.2.3 管制员视程点更新 (`'`)

**请求格式：**
```
':[呼号]:[视程点索引]:[纬度]:[经度]
```

**示例：**
```
':ZSHA_CTR:0:36.67349:120.45621
```

**参数说明：**
- `[呼号]`: 管制员呼号
- `[视程点索引]`: 视程点的索引编号
- `[纬度]/[经度]`: 视程点的地理坐标

**返回信息：**
- 无直接返回信息，服务器更新管制员的视程点信息

### 3.3 飞行计划命令

#### 3.3.1 提交飞行计划 (`$FP`)

**请求格式：**
```
$FP:[呼号]:[服务器名称]:[飞行规则]:[机型]:[数据]:[出发机场]:[起飞时间]:[数据]:[巡航高度]:[目的机场]:[数据1]:[数据2]:[数据3]:[数据4]:[备降机场]:[航路]
```

**示例：**
```
$FP:CPA421:SERVER:I:H/A320/L:474:ZYTL:1115:0:FL371:ZYHB:1:18:2:26:ZYCC:/V/ SEL/AHFL VENOS A588 NULRA W206 MAGBI W656 ISLUK W629 LARUN
```

**参数说明：**
- `[呼号]`: 飞行员呼号
- `[服务器名称]`: 服务器名称，通常为"SERVER"
- `[飞行规则]`: 飞行规则（I=IFR, V=VFR）
- `[机型]`: 航空器类型
- `[出发机场]`: 出发机场的ICAO代码
- `[起飞时间]`: 预计起飞时间
- `[巡航高度]`: 巡航高度（如FL371表示37100英尺）
- `[目的机场]`: 目的机场的ICAO代码
- `[备降机场]`: 备降机场的ICAO代码
- `[航路]`: 飞行航路信息

**返回信息：**
- 成功：服务器将飞行计划广播给范围内的管制员
- 失败：服务器返回错误消息，如`$ER:[呼号]:Syntax error` - 语法错误

#### 3.3.2 管制员编辑飞行计划 (`$AM`)

**请求格式：**
```
$AM:[管制员呼号]:[服务器名称]:[飞行员呼号]:[类型]:[机型]:[巡航速度]:[出发机场]:[出发时间]:[数据]:[巡航高度]:[目的地机场]:[数据1]:[数据2]:[数据3]:[数据4]:[备降机场]
```

**示例：**
```
$AM:ZYSH_CTR:SERVER:CPA421:I:H/A320/L:474:ZYTL:1115:0:FL371:ZYHB:11:8:22:6:ZYCC
```

**参数说明：**
- `[管制员呼号]`: 执行编辑操作的管制员呼号
- `[服务器名称]`: 服务器名称，通常为"SERVER"
- `[飞行员呼号]`: 被编辑飞行计划的飞行员呼号
- `[类型]`: 飞行计划类型
- `[机型]`: 航空器型号
- `[巡航速度]`: 巡航速度
- `[出发机场]`: 出发机场
- `[出发时间]`: 预计出发时间
- `[巡航高度]`: 巡航高度
- `[目的地机场]`: 目的地机场
- `[备降机场]`: 备降机场

**返回信息：**
- 成功：服务器广播更新后的飞行计划给范围内的客户端
- 失败：服务器返回错误消息

### 3.4 通信命令

#### 3.4.1 消息传输 (`#TM`)

**请求格式：**
```
#TM:[发送方呼号]:[接收方呼号]:[消息内容]
```

**示例：**
```
#TM:CES2352:ZGGG_APP:Requesting taxi clearance
```

**参数说明：**
- `[发送方呼号]`: 发送消息的客户端呼号
- `[接收方呼号]`: 接收消息的客户端呼号或频率
- `[消息内容]`: 消息文本内容

**返回信息：**
- 服务器将消息转发给指定的接收方
- 如果接收方是频率，则转发给所有在该频率上的客户端

#### 3.4.2 客户端查询 (`$CQ`)

**请求格式：**
```
$CQ:[查询方呼号]:[目标呼号]:[查询类型]
```

**示例：**
```
$CQ:SERVER:CES2352:ATIS
```

**参数说明：**
- `[查询方呼号]`: 发起查询的客户端呼号
- `[目标呼号]`: 被查询的客户端呼号
- `[查询类型]`: 查询类型，如ATIS、METAR等

**返回信息：**
- 服务器或目标客户端返回相应的查询结果

#### 3.4.3 客户端响应 (`$CR`)

**请求格式：**
```
$CR:[响应方呼号]:[目标呼号]:[响应内容]
```

**示例：**
```
$CR:ZGGG_APP:CES2352:Information Alpha, runway 01L in use
```

**参数说明：**
- `[响应方呼号]`: 提供响应的客户端呼号
- `[目标呼号]`: 接收响应的客户端呼号
- `[响应内容]`: 响应文本内容

**返回信息：**
- 服务器将响应转发给指定的目标客户端

#### 3.4.4 请求移交 (`$HO`)

**请求格式：**
```
$HO:[请求方呼号]:[目标管制员呼号]:[航班呼号]
```

**示例：**
```
$HO:ZSSS_APP:ZSHA_CTR:CES2352
```

**参数说明：**
- `[请求方呼号]`: 发起移交请求的管制员呼号
- `[目标管制员呼号]`: 接收移交请求的管制员呼号
- `[航班呼号]`: 需要移交的航班呼号

**返回信息：**
- 服务器将请求转发给目标管制员

#### 3.4.5 接受移交 (`$HA`)

**请求格式：**
```
$HA:[接收方呼号]:[请求方呼号]:[航班呼号]
```

**示例：**
```
$HA:ZSHA_CTR:ZSSS_APP:CES2352
```

**参数说明：**
- `[接收方呼号]`: 接受移交的管制员呼号
- `[请求方呼号]`: 发起移交请求的管制员呼号
- `[航班呼号]`: 需要移交的航班呼号

**返回信息：**
- 服务器将接受信息转发给请求方管制员

#### 3.4.6 ProController消息 (`#PC`)

**请求格式：**
```
#PC:[发送方呼号]:[接收方呼号]:[消息类型]:[数据]:[航班呼号]
```

**示例：**
```
#PC:ZSHA_CTR:ZSSS_APP:CCP:HC:CES2352
```

**参数说明：**
- `[发送方呼号]`: 发送消息的管制员呼号
- `[接收方呼号]`: 接收消息的管制员呼号
- `[消息类型]`: ProController特定消息类型
- `[数据]`: 附加数据
- `[航班呼号]`: 相关航班呼号

**返回信息：**
- 服务器将消息转发给指定的接收方管制员

#### 3.4.7 SquawkBox消息 (`#SB`)

**请求格式：**
```
#SB:[发送方呼号]:[接收方呼号]:[消息内容]
```

**示例：**
```
#SB:ZSHA_CTR:CES7199:FSIPIR:0:ZZZ:C172:3.73453:1.32984:174.00000:3.3028DC0.98CF9A41:L1P:Cessna Skyhawk 172SP
```

**参数说明：**
- `[发送方呼号]`: 发送消息的客户端呼号
- `[接收方呼号]`: 接收消息的客户端呼号
- `[消息内容]`: SquawkBox特定格式的消息内容

**返回信息：**
- 服务器将消息转发给指定的接收方客户端

#### 3.4.1 发送消息 (`#TM`)

**请求格式：**
```
#TM:[发送方呼号]:[接收方呼号或频率]:[消息内容]
```

**示例：**
```
#TM:ZSHA_CTR:ZSSS_APP:111
```

**参数说明：**
- `[发送方呼号]`: 发送消息的客户端呼号
- `[接收方呼号或频率]`: 接收消息的客户端呼号，或频率（格式为@频率）
- `[消息内容]`: 消息内容

**返回信息：**
- 无直接返回信息，服务器将消息转发给目标客户端或频率上的所有客户端

#### 3.4.2 客户端查询 (`$CQ`)

**请求格式：**
```
$CQ:[发送方呼号]:[目标]:[查询类型]:[查询参数]
```

**示例：**
```
// 查询飞行计划
$CQ:ZYSH_CTR:SERVER:FP:CPA421

// 修改飞行计划高度
$CQ:ZYSH_CTR:@94835:FA:CPA421:31100
```

**参数说明：**
- `[发送方呼号]`: 发送查询的客户端呼号
- `[目标]`: 查询目标（服务器或频率）
- `[查询类型]`: 查询的类型（如FP表示飞行计划）
- `[查询参数]`: 查询的具体参数

**返回信息：**
- 根据查询类型不同，返回不同的响应，如：
  - 查询飞行计划：返回该航班的完整飞行计划信息
  - 修改飞行计划：无直接返回，服务器会更新相关数据

#### 3.4.3 客户端响应 (`$CR`)

**请求格式：**
```
$CR:[发送方呼号]:[目标]:[响应类型]:[响应参数]
```

**示例：**
```
// 发送ATIS信息
$CR:ZSHA_CTR:SERVER:ATIS:T:ZSHA_CTR Shanghai Control

// 发送管制能力信息
$CR:ZSHA_CTR:ZSSS_APP:CAPS:ATCINFO=1:SECPOS=1:MODELDESC=1:ONGOINGCOORD=1:NEWINFO=1:TEAMSPEAK=1:ICAOEQ=1
```

**参数说明：**
- `[发送方呼号]`: 发送响应的客户端呼号
- `[目标]`: 响应目标（服务器或其他客户端）
- `[响应类型]`: 响应的类型（如ATIS、CAPS等）
- `[响应参数]`: 响应的具体参数

**返回信息：**
- 无直接返回信息，服务器将响应转发给目标客户端

#### 3.4.4 请求移交 (`$HO`)

**请求格式：**
```
$HO:[发送方呼号]:[接收方呼号]:[目标呼号]
```

**示例：**
```
$HO:ZSSS_APP:ZSHA_CTR:CES2352
```

**参数说明：**
- `[发送方呼号]`: 发送移交请求的管制员呼号
- `[接收方呼号]`: 接收移交请求的管制员呼号
- `[目标呼号]`: 被移交的飞行员呼号

**返回信息：**
- 无直接返回信息，服务器将移交请求转发给接收方管制员

#### 3.4.5 接受移交 (`$HA`)

**请求格式：**
```
$HA:[发送方呼号]:[接收方呼号]:[目标呼号]
```

**示例：**
```
$HA:ZSHA_CTR:ZSSS_APP:CES2352
```

**参数说明：**
- 与请求移交类似

**返回信息：**
- 无直接返回信息，服务器将接受移交消息转发给相关客户端

### 3.5 其他命令

#### 3.5.1 断开客户端连接 (`$!!`)

**请求格式：**
```
$!!:[管制员呼号]:[目标呼号]:[原因]
```

**示例：**
```
$!!:ZSHA_CTR:CPA421:test
```

**参数说明：**
- `[管制员呼号]`: 执行断开操作的管制员呼号
- `[目标呼号]`: 被断开连接的客户端呼号
- `[原因]`: 断开连接的原因

**返回信息：**
- 成功：目标客户端被断开连接
- 失败：服务器返回错误消息

#### 3.5.2 错误消息 (`$ER`)

**请求格式：**
```
$ER:[服务器名称]:[目标呼号]:[错误代码]:[环境]:[错误描述]
```

**示例：**
```
$ER:SERVER:CES2352:001:SIM:Invalid CID/password
```

**参数说明：**
- `[服务器名称]`: 服务器名称
- `[目标呼号]`: 接收错误消息的客户端呼号
- `[错误代码]`: 错误代码
- `[环境]`: 错误发生的环境
- `[错误描述]`: 错误的详细描述

**返回信息：**
- 无直接返回信息，这是服务器向客户端发送的错误通知

#### 3.5.3 风速变化 (`#DL`)

**请求格式：**
```
#DL:[发送方呼号]:[接收方呼号]:[风速]:[风向]:[高度]
```

**示例：**
```
#DL:ZSHA_TWR:CES2352:5:270:1000
```

**参数说明：**
- `[发送方呼号]`: 发送风速更新的客户端呼号
- `[接收方呼号]`: 接收更新的客户端呼号
- `[风速]`: 风速数据
- `[风向]`: 风向数据
- `[高度]`: 高度数据

**返回信息：**
- 无直接返回信息，服务器将更新转发给目标客户端

#### 3.5.4 管制员子视程点更新 (`'`)

**请求格式：**
```
'[管制员呼号]:[纬度]:[经度]:[高度]:[数据]
```

**示例：**
```
'ZGGG_APP:23.456:113.789:1000:0
```

**参数说明：**
- `[管制员呼号]`: 管制员呼号
- `[纬度]/[经度]`: 子视程点的地理位置坐标
- `[高度]`: 高度数据
- `[数据]`: 附加数据

**返回信息：**
- 服务器广播子视程点更新给范围内的客户端

#### 3.5.5 临时数据 (`$TD`)

**请求格式：**
```
$TD:[参数1]:[参数2]:[...]
```

**参数说明：**
- 用于传输临时或自定义数据

**返回信息：**
- 无特定返回信息，取决于具体实现

## 4. 之前FSD版本接口：METAR请求

暂时没有之前FSD的请求机场的METAR气象信息接口：

### 4.1 METAR请求 (`$AX`)

**请求格式：**
```
$AX:[呼号]:SERVER:METAR:[ICAO机场代码]
```

**示例：**
```
$AX:CES2352:SERVER:METAR:ZGGG
```

**参数说明：**
- `[呼号]`: 请求METAR的客户端呼号
- `[ICAO机场代码]`: 需要查询的机场ICAO代码

**返回信息：**
- 服务器会直接回复请求客户端METAR信息：
  ```
  $AR:SERVER:[呼号]:METAR:[METAR内容]
  ```

**注意事项：**
- METAR请求由服务器直接处理，不会转发给其他客户端
- 服务器必须配置METAR数据源才能正常响应此请求

## 5. 客户端连接流程

1. **建立TCP连接**：客户端连接到FSD服务器的TCP端口
2. **发送登录命令**：根据客户端类型发送 `#AA` (管制员) 或 `#AP` (飞行员) 命令
3. **身份验证**：服务器验证用户凭据和权限
4. **位置更新**：定期发送 `@` (飞行员) 或 `%` (管制员) 命令更新位置
5. **通信**：使用 `#TM`, `$CQ`, `$CR` 等命令进行消息交换
6. **断开连接**：发送 `#DA` (管制员) 或 `#DP` (飞行员) 命令正常退出

## 6. 关键数据结构

### 6.1 客户端信息

每个连接到服务器的客户端都会被表示为一个 Client 实例，包含以下关键信息：

- 呼号
- 用户信息
- 权限等级
- 设施类型
- 位置信息
- 飞行计划
- 连接状态

### 6.2 数据包解析

FSD 协议使用特定格式的数据包进行通信，SimpleFSD 通过以下方式解析数据包：

```go
func parserCommandLine(line []byte) (ClientCommand, []string) {
    for _, prefix := range PossibleClientCommands {
        if bytes.HasPrefix(line, prefix) {
            decodeLine := string(line[len(prefix):])
            return ClientCommand(prefix), strings.Split(decodeLine, ":")
        }
    }
    return TempData, nil
}
```

## 7. 频率通信机制

FSD 协议支持通过频率进行通信，这是模拟无线电通信的核心机制：

- 频率以数字形式表示（如 121.500 表示为 121500）
- 客户端可以通过 `@频率` 格式发送消息到特定频率
- 服务器会将消息转发给在该频率上的所有客户端
- 存在特殊频率（如 @94835）用于特定功能

## 8. 客户端开发建议

1. **实现核心命令**：首先实现连接、位置更新和基本通信命令
2. **处理断线重连**：设计合理的断线重连机制
3. **优化位置更新频率**：根据需要调整位置更新频率，避免服务器过载
4. **处理频率通信**：正确实现频率切换和通信功能
5. **错误处理**：妥善处理服务器返回的错误信息



## 9. 附录：命令速查表

| 命令 | 前缀 | 功能 | 请求示例 |
|-----|------|------|---------|
| AddAtc | #AA | 管制员登录 | `#AA:呼号:SERVER:CID:密码:等级:版本:...` |
| RemoveAtc | #DA | 管制员退出 | `#DA:呼号:SERVER` |
| AddPilot | #AP | 飞行员登录 | `#AP:呼号:SERVER:CID:密码:等级:版本:...` |
| RemovePilot | #DP | 飞行员退出 | `#DP:呼号:SERVER` |
| PilotPosition | @ | 飞行员位置更新 | `@:状态:应答机:数据:纬度:经度:高度:...` |
| AtcPosition | % | 管制员位置更新 | `%:呼号:频率:设施:视距:等级:纬度:...` |
| AtcSubVisPoint | ' | 管制员视程点更新 | `':呼号:索引:纬度:经度` |
| Message | #TM | 发送消息 | `#TM:发送方:接收方:消息内容` |
| WindDelta | #DL | 风向风速更新 | `#DL:发送方:接收方:风速:风向:高度` |
| SquawkBox | #SB | SquawkBox消息 | `#SB:发送方:接收方:类型:参数1:...` |
| RequestHandoff | $HO | 请求移交 | `$HO:发送方:接收方:目标呼号` |
| AcceptHandoff | $HA | 接受移交 | `$HA:发送方:接收方:目标呼号` |
| Plan | $FP | 提交飞行计划 | `$FP:呼号:SERVER:规则:机型:机场:...` |
| AtcEditPlan | $AM | 管制员编辑飞行计划 | `$AM:管制呼号:SERVER:目标呼号:规则:...` |
| KillClient | $!! | 踢出客户端 | `$!!:管制呼号:目标呼号:原因` |
| Error | $ER | 错误消息 | `$ER:呼号:错误内容` (服务器发送) |
| ClientQuery | $CQ | 客户端查询 | `$CQ:发送方:目标:查询类型:参数` |
| ClientResponse | $CR | 客户端响应 | `$CR:发送方:目标:响应类型:参数` |
| TempData | $TD | 临时数据 | `$TD:参数1:参数2:...` |

## 9. 注意事项

- SimpleFSD 目前只支持协议版本 9
- 呼号必须符合 3-12 个字符的长度限制
- 频率范围必须在 18000-36975 之间
- 客户端需要定期发送心跳包以保持连接
- 某些操作需要特定的权限等级